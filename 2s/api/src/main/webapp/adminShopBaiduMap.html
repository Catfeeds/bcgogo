<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.2"></script>
</head>
<body>
<div id="map_container" style=" width: 700px;height: 350px;"></div>
</body>
<script type="text/javascript">
    (function () {
        function getUrlParameter(name) {
            "use strict";
            return ((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || "";
        }

        var coordinateLat = getUrlParameter("coordinateLat"),
                basePath = decodeURIComponent(getUrlParameter("origin")),
                icon = new BMap.Icon("http://api.map.baidu.com/images/marker_red_sprite.png", new BMap.Size(20, 39), {infoWindowAnchor: new BMap.Size(10, 0)}),
                addressDetail = getUrlParameter("addressDetail"),
                city = getUrlParameter("city"),
                region = getUrlParameter("region"),
                coordinateLon = getUrlParameter("coordinateLon");
        if (!coordinateLat) {
            onBaiduMapSearch();
        } else {
            onBaiduMapCenterAndZoom(coordinateLon, coordinateLat);
        }

        function onBaiduMapSearch() {
            var map = new BMap.Map("map_container");
            map.enableScrollWheelZoom();
            map.enableContinuousZoom();
            map.centerAndZoom(city);
            var local = new BMap.LocalSearch(map, {
                renderOptions: {map: map},
                pageCapacity: 1
            });
            local.search(addressDetail);
//            local.search(city + region + addressDetail);
            local.setSearchCompleteCallback(function (results) {
                if (local.getStatus() !== BMAP_STATUS_SUCCESS) {
//                    callbackInternal("noresult");
                    var myGeo = new BMap.Geocoder();
                    console.log("use Geocoder");
                    myGeo.getPoint(city +region + addressDetail, function (point) {
                        if (point) {
                            map.centerAndZoom(point, 16);
                            addMaker(map, point, addressDetail);
                            callbackInternal("coordinate", point.lng, point.lat);
                        }
                    }, city);
                }
            });
            local.setMarkersSetCallback(function (results) {
                for (var i = results.length; i--;) {
                    var marker = results[i].marker,
                            position = marker.getPosition();
                    addMaker(map, position, addressDetail);
                    if (!addressDetail) {
                        callbackInternal("noresult");
                    } else {
                        callbackInternal("coordinate", position.lng, position.lat);
                    }
                }
            });
            map.addEventListener("click", function (e) {
                if (!(e.overlay)) {
                    addMaker(map, e.point, true);
                    callbackInternal("coordinate", e.point.lng, e.point.lat);
                }
            });

        }

        function addMaker(map, point, isAdding) {
            map.clearOverlays();
            while (map.getOverlays().length != 0) {
                map.removeOverlay(map.getOverlays()[0]);
            }
            if (!isAdding)return;
            var marker = new BMap.Marker(point, {
                enableMassClear: false,
                raiseOnDrag: true
            });
            marker.setPosition(point);
            marker.setIcon(icon);
            marker.enableDragging();
            map.addOverlay(marker);
            marker.show();
            marker.addEventListener("dragend", function (e) {
                callbackInternal("coordinate", e.point.lng, e.point.lat)
            });
            marker.addEventListener("click", function (e) {
                callbackInternal("coordinate", e.point.lng, e.point.lat);
            });
        }

        function onBaiduMapCenterAndZoom(lng, lat) {
            if (!lng || !lat)return;
            var map = new BMap.Map("map_container");
            map.enableScrollWheelZoom();
            map.enableContinuousZoom();
            var point = new BMap.Point(lng, lat);
            map.centerAndZoom(point, 16);
            addMaker(map, point, true);
            map.addEventListener("click", function (e) {
                if (!(e.overlay)) {
                    addMaker(map, e.point, true);
                    callbackInternal("coordinate", e.point.lng, e.point.lat)
                }
            });
        }

        function callbackInternal(type, lng, lat) {
            var o = {
                type: type,
                lng: lng,
                lat: lat
            };
            console.log(o);
            this.parent.window.postMessage(o, basePath);
        }
    })();
</script>
</html>